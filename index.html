<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CatatKas Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/512/wallet.png">
    <link rel="manifest" id="my-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #020617;
            color: #f8fafc;
            -webkit-font-smoothing: antialiased;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .btn-active:active { transform: scale(0.96); transition: 0.1s; }

        /* Mencegah teks meluap */
        .truncate-custom {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        input[type="date"] { color-scheme: dark; }
    </style>
</head>
<body class="min-h-screen">

    <script>
        const manifest = {
            "name": "CatatKas Pro",
            "short_name": "CatatKas",
            "start_url": window.location.href,
            "display": "standalone",
            "background_color": "#020617",
            "theme_color": "#020617",
            "icons": [{ "src": "https://img.icons8.com/fluency/512/wallet.png", "sizes": "512x512", "type": "image/png" }]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.querySelector('#my-manifest').setAttribute('href', URL.createObjectURL(blob));
    </script>

    <!-- AUTH SCREEN -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center p-6 transition-all duration-500">
        <div class="mb-10 text-center">
            <!-- Ikon SVG Dompet asli sebagai pengganti W -->
            <div class="w-20 h-20 bg-blue-600/20 rounded-3xl flex items-center justify-center mx-auto mb-4 border border-blue-500/30">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"></path></svg>
            </div>
            <h1 class="text-2xl font-black tracking-tighter">CatatKas Pro</h1>
            <p class="text-slate-500 text-[10px] font-bold uppercase tracking-[0.3em] mt-1">Sistem Terkunci</p>
        </div>
        <div class="flex gap-3 mb-12" id="pin-dots">
            <div class="w-3 h-3 rounded-full border border-slate-700"></div>
            <div class="w-3 h-3 rounded-full border border-slate-700"></div>
            <div class="w-3 h-3 rounded-full border border-slate-700"></div>
            <div class="w-3 h-3 rounded-full border border-slate-700"></div>
            <div class="w-3 h-3 rounded-full border border-slate-700"></div>
            <div class="w-3 h-3 rounded-full border border-slate-700"></div>
        </div>
        <div class="grid grid-cols-3 gap-5">
            <button onclick="inputPin('1')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl btn-active">1</button>
            <button onclick="inputPin('2')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl btn-active">2</button>
            <button onclick="inputPin('3')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl btn-active">3</button>
            <button onclick="inputPin('4')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl btn-active">4</button>
            <button onclick="inputPin('5')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl btn-active">5</button>
            <button onclick="inputPin('6')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl btn-active">6</button>
            <button onclick="inputPin('7')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl btn-active">7</button>
            <button onclick="inputPin('8')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl btn-active">8</button>
            <button onclick="inputPin('9')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl btn-active">9</button>
            <button onclick="clearPin()" class="text-[10px] font-black uppercase text-slate-500">Reset</button>
            <button onclick="inputPin('0')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl btn-active">0</button>
            <button onclick="checkPin()" class="w-16 h-16 rounded-full bg-blue-600 font-bold text-white shadow-lg shadow-blue-900/40 btn-active">OK</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden opacity-0 transition-all duration-700">
        
        <!-- HEADER RAMPING -->
        <div class="sticky top-0 z-50 bg-slate-950/90 backdrop-blur-xl border-b border-white/5 px-6 pt-12 pb-5">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-2.5">
                    <div class="p-1.5 bg-blue-600/20 rounded-lg border border-blue-500/20">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"></path></svg>
                    </div>
                    <span class="font-black text-xs uppercase tracking-widest text-slate-400">CatatKas</span>
                </div>
                <div class="flex gap-4">
                    <button onclick="fetchFromCloud()" class="text-slate-400 active:text-blue-500 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-1 mb-5">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Total Saldo</p>
                <h2 id="total-balance" class="text-4xl font-black tracking-tighter text-white">Rp 0</h2>
            </div>

            <div class="flex gap-2">
                <div class="flex-1 glass-card p-3 rounded-2xl flex items-center gap-3">
                    <div class="w-7 h-7 rounded-lg bg-emerald-500/20 text-emerald-500 flex items-center justify-center font-bold">↓</div>
                    <div>
                        <p class="text-[8px] font-black text-slate-500 uppercase">Masuk</p>
                        <p id="month-in" class="text-xs font-black text-emerald-400">Rp 0</p>
                    </div>
                </div>
                <div class="flex-1 glass-card p-3 rounded-2xl flex items-center gap-3">
                    <div class="w-7 h-7 rounded-lg bg-rose-500/20 text-rose-500 flex items-center justify-center font-bold">↑</div>
                    <div>
                        <p class="text-[8px] font-black text-slate-500 uppercase">Keluar</p>
                        <p id="month-out" class="text-xs font-black text-rose-400">Rp 0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- FORM INPUT -->
        <div class="px-6 py-8">
            <div class="bg-slate-900/40 rounded-[2.5rem] p-6 border border-white/5 mb-8">
                <div class="flex justify-between items-center mb-5">
                    <span id="form-title" class="text-[10px] font-black uppercase tracking-widest text-slate-500">Transaksi Baru</span>
                    <button id="cancel-edit" onclick="resetForm()" class="hidden text-rose-500 text-[10px] font-black">BATAL</button>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="space-y-1.5">
                        <label class="text-[9px] font-black text-slate-600 uppercase ml-1">Tanggal</label>
                        <input type="date" id="t-date" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3.5 text-xs font-bold outline-none focus:border-blue-500 transition-all">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[9px] font-black text-slate-600 uppercase ml-1">Nominal</label>
                        <input type="tel" id="t-amount" oninput="formatDisplayAmount(this)" placeholder="0" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3.5 text-xs font-black outline-none focus:border-blue-500 transition-all">
                    </div>
                </div>
                <div class="space-y-1.5 mb-6">
                    <label class="text-[9px] font-black text-slate-600 uppercase ml-1">Keterangan</label>
                    <input type="text" id="t-desc" placeholder="Bayar apa?" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3.5 text-xs font-bold outline-none focus:border-blue-500 transition-all">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="saveToCloud('IN')" class="btn-active bg-emerald-600 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-emerald-900/20">Masuk</button>
                    <button onclick="saveToCloud('OUT')" class="btn-active bg-rose-600 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-rose-900/20">Keluar</button>
                </div>
            </div>

            <!-- RIWAYAT -->
            <div class="flex items-center justify-between mb-6 px-1">
                <h3 class="font-black text-sm uppercase tracking-widest text-slate-500">Riwayat Aktivitas</h3>
                <input type="month" id="filter-month" onchange="updateUI()" class="bg-transparent border-none text-blue-500 font-black text-xs outline-none">
            </div>

            <div id="transaction-list" class="space-y-3">
                <!-- Data akan dimuat di sini -->
            </div>
        </div>
    </div>

    <!-- LOADING SPINNER -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-[150] bg-slate-950/80 backdrop-blur-sm flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-slate-800 border-t-blue-500 rounded-full animate-spin mb-4"></div>
        <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest">Sinkronisasi...</p>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwiKSUdRHExo6dd_z03wf5TckjDNSUVJRevpoVBBLFdU1LFVf1X2KnPHU5zp2wUd4TW6g/exec"; 
        let currentPin = "", CORRECT_PIN = "123456", transactions = [], editId = null;

        window.onload = () => {
            const now = new Date();
            document.getElementById('t-date').valueAsDate = now;
            document.getElementById('filter-month').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        };

        function inputPin(d) {
            if(currentPin.length < 6) {
                currentPin += d;
                updateDots();
                if(currentPin.length === 6) setTimeout(checkPin, 200);
            }
        }

        function clearPin() { currentPin = ""; updateDots(); }
        
        function updateDots() {
            const dots = document.getElementById('pin-dots').children;
            for(let i=0; i<6; i++) {
                dots[i].className = i < currentPin.length ? "w-3 h-3 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6]" : "w-3 h-3 rounded-full border border-slate-700";
            }
        }

        function checkPin() {
            if(currentPin === CORRECT_PIN) {
                const auth = document.getElementById('auth-overlay');
                const app = document.getElementById('main-app');
                auth.style.opacity = '0';
                setTimeout(() => {
                    auth.style.display = 'none';
                    app.classList.remove('hidden');
                    setTimeout(() => app.style.opacity = '1', 50);
                    fetchFromCloud();
                }, 500);
            } else {
                alert("PIN SALAH!");
                clearPin();
            }
        }

        async function fetchFromCloud() {
            toggleLoading(true);
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                transactions = data.map(item => ({...item, amount: parseInt(item.amount)}));
                updateUI();
            } catch (e) { console.error(e); }
            toggleLoading(false);
        }

        async function saveToCloud(type) {
            const amount = parseInt(document.getElementById('t-amount').value.replace(/\D/g, '')) || 0;
            const desc = document.getElementById('t-desc').value;
            const date = document.getElementById('t-date').value;
            if (!desc || amount <= 0 || !date) return;
            toggleLoading(true);
            try {
                await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: editId ? 'edit' : 'add', id: editId || Date.now().toString(), date, description: desc, amount, type }) 
                });
                await fetchFromCloud(); resetForm();
            } catch (e) { alert("Gagal menyimpan."); }
            toggleLoading(false);
        }

        function toggleLoading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }
        function formatDisplayAmount(input) { let v = input.value.replace(/\D/g, ""); input.value = v ? new Intl.NumberFormat('id-ID').format(v) : ""; }
        function formatIDR(n) { return "Rp " + new Intl.NumberFormat('id-ID').format(n); }
        
        function resetForm() { 
            editId = null; 
            document.getElementById('t-desc').value = ""; 
            document.getElementById('t-amount').value = ""; 
            document.getElementById('form-title').innerText = "Transaksi Baru"; 
            document.getElementById('cancel-edit').classList.add('hidden'); 
        }

        function startEdit(id) {
            const t = transactions.find(x => x.id.toString() === id.toString());
            if(!t) return;
            editId = id;
            document.getElementById('t-date').value = t.date;
            document.getElementById('t-desc').value = t.description;
            document.getElementById('t-amount').value = new Intl.NumberFormat('id-ID').format(t.amount);
            document.getElementById('form-title').innerText = "Edit Data";
            document.getElementById('cancel-edit').classList.remove('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function updateUI() {
            const list = document.getElementById('transaction-list'), filterMonth = document.getElementById('filter-month').value;
            list.innerHTML = ""; let totalBal = 0, mIn = 0, mOut = 0;
            
            transactions.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
                const isIn = t.type === 'IN'; totalBal += isIn ? t.amount : -t.amount;
                if (t.date.startsWith(filterMonth)) { if (isIn) mIn += t.amount; else mOut += t.amount; }
            });

            document.getElementById('total-balance').innerText = formatIDR(totalBal);
            document.getElementById('month-in').innerText = formatIDR(mIn);
            document.getElementById('month-out').innerText = formatIDR(mOut);

            const filtered = transactions.filter(t => t.date.startsWith(filterMonth)).sort((a,b) => new Date(b.date) - new Date(a.date));
            if(filtered.length === 0) {
                list.innerHTML = `<div class="py-16 text-center glass-card rounded-[2.5rem]"><p class="text-slate-600 font-black text-[10px] uppercase tracking-widest">Tidak ada aktivitas</p></div>`;
                return;
            }

            filtered.forEach(t => {
                const isIn = t.type === 'IN';
                const item = document.createElement('div');
                item.className = "glass-card p-4 rounded-2xl flex items-center justify-between btn-active cursor-pointer";
                item.onclick = () => startEdit(t.id);
                
                // Format tanggal lebih ringkas: "12 Feb"
                const d = new Date(t.date);
                const day = d.getDate().toString().padStart(2, '0');
                const months = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
                const shortDate = `${day} ${months[d.getMonth()]}`;

                item.innerHTML = `
                    <div class="flex items-center gap-4 min-w-0">
                        <div class="w-1 h-8 rounded-full ${isIn ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.4)]' : 'bg-rose-500 shadow-[0_0_8px_rgba(244,63,94,0.4)]'}"></div>
                        <div class="min-w-0">
                            <p class="font-bold text-xs text-white truncate-custom">${t.description}</p>
                            <p class="text-[9px] text-slate-500 font-black uppercase tracking-tighter">${shortDate}</p>
                        </div>
                    </div>
                    <div class="text-right ml-3 shrink-0">
                        <p class="font-black text-xs ${isIn ? 'text-emerald-400' : 'text-rose-400'}">${isIn ? '+' : '-'} ${new Intl.NumberFormat('id-ID').format(t.amount)}</p>
                    </div>
                `;
                list.appendChild(item);
            });
        }
    </script>
</body>
</html>

a
