<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CatatKas</title>
    
    <!-- Meta untuk App Mode -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563eb">
    
    <!-- Ikon High Resolution -->
    <link rel="icon" type="image/png" sizes="512x512" href="https://img.icons8.com/fluency/512/wallet.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/512/wallet.png">

    <!-- Web App Manifest -->
    <link rel="manifest" id="app-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; touch-action: manipulation; background-color: #2563eb; }
        .glass-header { background: linear-gradient(180deg, #2563eb 0%, #1e40af 100%); padding-top: calc(1.5rem + env(safe-area-inset-top)); }
        .app-card { border-radius: 2.5rem; box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.1); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        * { -webkit-tap-highlight-color: transparent; outline: none !important; }
        .num-btn { background: rgba(255,255,255,0.1); color: white; border-radius: 999px; height: 4.5rem; width: 4.5rem; display: flex; align-items: center; justify-content: center; font-size: 1.875rem; font-weight: 600; transition: all 0.2s; cursor: pointer; }
        .num-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.9); }
    </style>
</head>
<body class="min-h-screen overflow-hidden">
    
    <!-- LOADING -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-[110] bg-white/90 backdrop-blur-md flex items-center justify-center">
        <div class="text-center"><div class="loader mx-auto mb-4"></div><p class="text-blue-600 font-bold text-xs tracking-widest uppercase">Sinkronisasi...</p></div>
    </div>

    <!-- PIN SECURITY -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-[#2563eb] flex items-center justify-center p-6 transition-all duration-700">
        <div class="w-full max-w-xs text-center">
            <div class="mb-10">
                <img src="https://img.icons8.com/fluency/512/wallet.png" class="w-24 h-24 mx-auto mb-6 drop-shadow-2xl" alt="Logo">
                <h1 class="text-4xl font-extrabold text-white mb-1 tracking-tighter">CatatKas</h1>
                <p class="text-blue-100 text-[10px] font-black uppercase tracking-[0.3em] opacity-60">Security Locked</p>
            </div>
            
            <div class="flex justify-center gap-4 mb-16">
                <div id="dot-1" class="h-3 w-3 rounded-full border-2 border-white/30 transition-all"></div>
                <div id="dot-2" class="h-3 w-3 rounded-full border-2 border-white/30 transition-all"></div>
                <div id="dot-3" class="h-3 w-3 rounded-full border-2 border-white/30 transition-all"></div>
                <div id="dot-4" class="h-3 w-3 rounded-full border-2 border-white/30 transition-all"></div>
                <div id="dot-5" class="h-3 w-3 rounded-full border-2 border-white/30 transition-all"></div>
                <div id="dot-6" class="h-3 w-3 rounded-full border-2 border-white/30 transition-all"></div>
            </div>

            <div class="grid grid-cols-3 gap-y-6">
                <div onclick="inputPin('1')" class="num-btn mx-auto">1</div>
                <div onclick="inputPin('2')" class="num-btn mx-auto">2</div>
                <div onclick="inputPin('3')" class="num-btn mx-auto">3</div>
                <div onclick="inputPin('4')" class="num-btn mx-auto">4</div>
                <div onclick="inputPin('5')" class="num-btn mx-auto">5</div>
                <div onclick="inputPin('6')" class="num-btn mx-auto">6</div>
                <div onclick="inputPin('7')" class="num-btn mx-auto">7</div>
                <div onclick="inputPin('8')" class="num-btn mx-auto">8</div>
                <div onclick="inputPin('9')" class="num-btn mx-auto">9</div>
                <div onclick="clearPin()" class="flex items-center justify-center text-white/50 text-[10px] font-black uppercase tracking-widest cursor-pointer active:text-white">Clear</div>
                <div onclick="inputPin('0')" class="num-btn mx-auto">0</div>
                <div onclick="checkPin()" class="flex items-center justify-center bg-emerald-400 text-emerald-900 h-16 w-16 rounded-full mx-auto font-black shadow-lg active:scale-90 transition-all cursor-pointer">OK</div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="max-w-md mx-auto h-screen flex flex-col bg-white relative opacity-0 transition-opacity duration-700 overflow-y-auto pb-20">
        <div class="glass-header sticky top-0 z-20 px-6 pb-10 text-white rounded-b-[3.5rem] shadow-2xl">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-black tracking-tighter">CatatKas</h1>
                    <p class="text-blue-100 text-[10px] font-black uppercase tracking-widest opacity-80" id="current-period-label">Memuat...</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="fetchFromCloud()" class="bg-white/20 p-3 rounded-2xl active:scale-90 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    </button>
                    <button onclick="location.reload()" class="bg-white/20 p-3 rounded-2xl active:scale-90 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    </button>
                </div>
            </div>
            <div class="mb-2">
                <p class="text-blue-100/70 text-[10px] font-black uppercase tracking-[0.2em] mb-1">Total Saldo</p>
                <h2 class="text-5xl font-black tracking-tighter" id="total-balance">Rp 0</h2>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-10">
                <div class="bg-emerald-400/20 backdrop-blur-md p-5 rounded-[2rem] border border-white/10">
                    <p class="text-[10px] uppercase font-black text-emerald-300 mb-1">Pemasukan</p>
                    <p class="text-lg font-black text-white" id="month-in">Rp 0</p>
                </div>
                <div class="bg-rose-400/20 backdrop-blur-md p-5 rounded-[2rem] border border-white/10">
                    <p class="text-[10px] uppercase font-black text-rose-300 mb-1">Pengeluaran</p>
                    <p class="text-lg font-black text-white" id="month-out">Rp 0</p>
                </div>
            </div>
        </div>

        <div class="px-8 py-6 flex items-center justify-between">
            <h3 class="font-black text-slate-800 text-xl tracking-tight">Transaksi</h3>
            <input type="month" id="filter-month" onchange="updateUI()" class="bg-slate-100 border-none text-blue-600 text-xs font-black rounded-xl px-4 py-2 outline-none">
        </div>

        <div class="px-8">
            <div class="bg-white app-card border border-slate-100 p-8 mb-10 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="form-title" class="font-black text-slate-400 text-[11px] uppercase tracking-[0.2em]">Input Baru</h3>
                    <button id="cancel-edit" onclick="resetForm()" class="hidden text-rose-500 font-black text-[11px] uppercase">Batal</button>
                </div>
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 ml-1 uppercase">Tanggal</label><input type="date" id="t-date" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold text-xs focus:ring-2 focus:ring-blue-500 outline-none"></div>
                        <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 ml-1 uppercase">Nominal</label><input type="tel" id="t-amount" oninput="formatDisplayAmount(this)" placeholder="0" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black text-sm focus:ring-2 focus:ring-blue-500 outline-none"></div>
                    </div>
                    <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 ml-1 uppercase">Keterangan</label><input type="text" id="t-desc" placeholder="Tulis catatan..." class="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold text-xs focus:ring-2 focus:ring-blue-500 outline-none"></div>
                    <div class="grid grid-cols-2 gap-4 pt-4">
                        <button onclick="saveToCloud('IN')" class="bg-emerald-500 text-white font-black py-5 rounded-[1.5rem] shadow-xl shadow-emerald-100 active:scale-95 text-[11px] uppercase tracking-widest">Dana Masuk</button>
                        <button onclick="saveToCloud('OUT')" class="bg-rose-500 text-white font-black py-5 rounded-[1.5rem] shadow-xl shadow-rose-100 active:scale-95 text-[11px] uppercase tracking-widest">Pengeluaran</button>
                    </div>
                </div>
            </div>
            <div id="transaction-list" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // Setup Manifest secara aman
        (function() {
            const manifest = {
                "name": "CatatKas Pro",
                "short_name": "CatatKas",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#2563eb",
                "theme_color": "#2563eb",
                "icons": [{
                    "src": "https://img.icons8.com/fluency/512/wallet.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }]
            };
            const stringManifest = JSON.stringify(manifest);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            document.getElementById('app-manifest').setAttribute('href', URL.createObjectURL(blob));
        })();

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwiKSUdRHExo6dd_z03wf5TckjDNSUVJRevpoVBBLFdU1LFVf1X2KnPHU5zp2wUd4TW6g/exec"; 
        let currentPin = "", CORRECT_PIN = "123456", transactions = [], editId = null;

        window.onload = () => {
            const now = new Date();
            document.getElementById('t-date').valueAsDate = now;
            document.getElementById('filter-month').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            
            // Pendaftaran Service Worker yang lebih tahan banting (Robust)
            if ('serviceWorker' in navigator) {
                // Mencoba mendaftarkan SW hanya jika protokol mendukung atau menggunakan fallback pasif
                try {
                    // Gunakan base64 untuk skrip kosong agar memenuhi syarat PWA "installable"
                    const swCode = "self.addEventListener('fetch', function(event) {});";
                    const swUrl = "data:text/javascript;base64," + btoa(swCode);
                    
                    navigator.serviceWorker.register(swUrl)
                        .then(() => console.log("SW Registered"))
                        .catch(err => {
                            console.warn("SW Registration Failed (expected in some envs):", err);
                            // Jika data: protocol gagal, biarkan saja agar tidak memutus aplikasi
                        });
                } catch (e) {
                    console.error("Critical SW error suppressed:", e);
                }
            }
        };

        function inputPin(d) { if(currentPin.length < 6) { currentPin += d; updateDots(); if(currentPin.length === 6) setTimeout(checkPin, 200); } }
        function clearPin() { currentPin = ""; updateDots(); }
        function updateDots() { for(let i=1; i<=6; i++) { const el = document.getElementById(`dot-${i}`); if(el) el.className = i <= currentPin.length ? "h-3 w-3 rounded-full bg-white shadow-[0_0_12px_rgba(255,255,255,0.8)]" : "h-3 w-3 rounded-full border-2 border-white/30"; } }
        function checkPin() { if(currentPin === CORRECT_PIN) unlockApp(); else { alert("PIN SALAH"); clearPin(); } }
        function unlockApp() { document.getElementById('auth-overlay').style.opacity = '0'; setTimeout(() => { document.getElementById('auth-overlay').style.display = 'none'; document.getElementById('main-app').style.opacity = '1'; document.body.style.overflow = 'auto'; }, 500); fetchFromCloud(); }

        async function fetchFromCloud() {
            toggleLoading(true);
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                transactions = data.map(item => ({...item, amount: parseInt(item.amount)}));
                updateUI();
            } catch (e) { console.error(e); }
            toggleLoading(false);
        }

        async function saveToCloud(type) {
            const amountStr = document.getElementById('t-amount').value.replace(/\D/g, '');
            const amount = parseInt(amountStr) || 0;
            const desc = document.getElementById('t-desc').value, date = document.getElementById('t-date').value;
            if (!desc || amount <= 0 || !date) return;
            toggleLoading(true);
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: editId ? 'edit' : 'add', id: editId || Date.now().toString(), date, description: desc, amount, type }) });
                await fetchFromCloud(); resetForm();
            } catch (e) { alert("Error simpan."); }
            toggleLoading(false);
        }

        function toggleLoading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }
        function formatDisplayAmount(input) { let v = input.value.replace(/\D/g, ""); input.value = v ? new Intl.NumberFormat('id-ID').format(v) : ""; }
        function formatIDR(n) { return "Rp" + new Intl.NumberFormat('id-ID').format(n); }
        function resetForm() { editId = null; document.getElementById('t-desc').value = ""; document.getElementById('t-amount').value = ""; document.getElementById('form-title').innerText = "Input Baru"; document.getElementById('cancel-edit').classList.add('hidden'); }

        function startEdit(id) {
            const t = transactions.find(x => x.id.toString() === id.toString());
            if(!t) return;
            editId = id; document.getElementById('t-date').value = t.date; document.getElementById('t-desc').value = t.description;
            document.getElementById('t-amount').value = new Intl.NumberFormat('id-ID').format(t.amount);
            document.getElementById('form-title').innerText = "Edit Transaksi"; document.getElementById('cancel-edit').classList.remove('hidden');
            const mainApp = document.getElementById('main-app');
            mainApp.scrollTo({top: 0, behavior: 'smooth'});
        }

        function updateUI() {
            const list = document.getElementById('transaction-list'), filterMonth = document.getElementById('filter-month').value;
            list.innerHTML = ""; let totalBal = 0, mIn = 0, mOut = 0;
            transactions.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
                const isIn = t.type === 'IN'; totalBal += isIn ? t.amount : -t.amount;
                if (t.date.startsWith(filterMonth)) { if (isIn) mIn += t.amount; else mOut += t.amount; }
            });
            document.getElementById('total-balance').innerText = formatIDR(totalBal);
            document.getElementById('month-in').innerText = formatIDR(mIn);
            document.getElementById('month-out').innerText = formatIDR(mOut);
            document.getElementById('current-period-label').innerText = new Date(filterMonth + "-01").toLocaleDateString('id-ID', {month:'long', year:'numeric'});
            const filtered = transactions.filter(t => t.date.startsWith(filterMonth)).sort((a,b) => new Date(b.date) - new Date(a.date));
            if(filtered.length === 0) { list.innerHTML = "<div class='text-center py-20 bg-slate-50 rounded-[2.5rem] text-slate-300 font-black text-xs uppercase tracking-widest'>Belum Ada Transaksi</div>"; return; }
            filtered.forEach(t => {
                const isIn = t.type === 'IN';
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-6 bg-white rounded-[2rem] shadow-sm border border-slate-50 active:scale-95 transition-all cursor-pointer";
                div.onclick = () => startEdit(t.id);
                div.innerHTML = `<div class="flex items-center gap-5"><div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-inner ${isIn ? 'bg-emerald-50 text-emerald-500' : 'bg-rose-50 text-rose-500'}">${isIn ? '￬' : '￪'}</div><div><p class="font-bold text-slate-800 text-sm tracking-tight">${t.description}</p><p class="text-[9px] text-slate-400 font-black uppercase tracking-widest">${t.date}</p></div></div><p class="font-black text-sm ${isIn ? 'text-emerald-500' : 'text-rose-500'}">${isIn ? '+' : '-'} ${formatIDR(t.amount)}</p>`;
                list.appendChild(div);
            });
        }
    </script>
</body>
</html>
