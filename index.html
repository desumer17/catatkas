<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CatatKas Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/512/wallet.png">
    <link rel="manifest" id="my-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #020617;
            color: #f8fafc;
            -webkit-font-smoothing: antialiased;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .btn-action {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-action:active { transform: scale(0.95); }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Fix for long date strings in screenshot */
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body class="min-h-screen">

    <script>
        // PWA Manifest Dynamic
        const manifest = {
            "name": "CatatKas Pro",
            "short_name": "CatatKas",
            "start_url": window.location.href,
            "display": "standalone",
            "background_color": "#020617",
            "theme_color": "#020617",
            "icons": [{ "src": "https://img.icons8.com/fluency/512/wallet.png", "sizes": "512x512", "type": "image/png" }]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.querySelector('#my-manifest').setAttribute('href', URL.createObjectURL(blob));
    </script>

    <!-- LOADING SCREEN -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-[150] bg-slate-950/90 backdrop-blur-sm flex items-center justify-center">
        <div class="loader border-t-blue-500 border-4 border-slate-800 rounded-full w-8 h-8 animate-spin"></div>
    </div>

    <!-- PIN AUTH -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center p-6 transition-all duration-500">
        <div class="mb-10 text-center">
            <img src="https://img.icons8.com/fluency/512/wallet.png" class="w-16 h-16 mx-auto mb-4">
            <h1 class="text-xl font-extrabold tracking-tight">Keamanan CatatKas</h1>
        </div>
        <div class="flex gap-3 mb-12">
            <div id="dot-1" class="w-3 h-3 rounded-full border border-slate-700"></div>
            <div id="dot-2" class="w-3 h-3 rounded-full border border-slate-700"></div>
            <div id="dot-3" class="w-3 h-3 rounded-full border border-slate-700"></div>
            <div id="dot-4" class="w-3 h-3 rounded-full border border-slate-700"></div>
            <div id="dot-5" class="w-3 h-3 rounded-full border border-slate-700"></div>
            <div id="dot-6" class="w-3 h-3 rounded-full border border-slate-700"></div>
        </div>
        <div class="grid grid-cols-3 gap-6">
            <!-- Num pad simple -->
            <button onclick="inputPin('1')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl active:bg-slate-800">1</button>
            <button onclick="inputPin('2')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl active:bg-slate-800">2</button>
            <button onclick="inputPin('3')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl active:bg-slate-800">3</button>
            <button onclick="inputPin('4')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl active:bg-slate-800">4</button>
            <button onclick="inputPin('5')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl active:bg-slate-800">5</button>
            <button onclick="inputPin('6')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl active:bg-slate-800">6</button>
            <button onclick="inputPin('7')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl active:bg-slate-800">7</button>
            <button onclick="inputPin('8')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl active:bg-slate-800">8</button>
            <button onclick="inputPin('9')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl active:bg-slate-800">9</button>
            <button onclick="clearPin()" class="text-xs font-bold text-slate-500 uppercase">Hapus</button>
            <button onclick="inputPin('0')" class="w-16 h-16 rounded-full bg-slate-900 font-bold text-xl active:bg-slate-800">0</button>
            <button onclick="checkPin()" class="w-16 h-16 rounded-full bg-blue-600 font-bold text-white shadow-lg shadow-blue-900/40">OK</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden opacity-0 transition-opacity duration-700">
        
        <!-- HEADER SLIM -->
        <div class="sticky top-0 z-50 bg-slate-950/95 backdrop-blur-md border-b border-white/5 px-5 pt-10 pb-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <img src="https://img.icons8.com/fluency/512/wallet.png" class="w-6 h-6">
                    <span class="font-extrabold text-sm tracking-tight text-slate-400">CatatKas</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="fetchFromCloud()" class="p-2 text-slate-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button>
                    <button onclick="location.reload()" class="p-2 text-slate-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button>
                </div>
            </div>
            
            <div class="mb-4">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Total Saldo</p>
                <h2 id="total-balance" class="text-3xl font-black tracking-tighter">Rp 0</h2>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div class="glass-card p-2.5 rounded-xl flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-emerald-500/10 text-emerald-500 flex items-center justify-center text-xs">↓</div>
                    <div>
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Masuk</p>
                        <p id="month-in" class="text-xs font-black text-emerald-400">Rp 0</p>
                    </div>
                </div>
                <div class="glass-card p-2.5 rounded-xl flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-rose-500/10 text-rose-500 flex items-center justify-center text-xs">↑</div>
                    <div>
                        <p class="text-[8px] font-bold text-slate-500 uppercase">Keluar</p>
                        <p id="month-out" class="text-xs font-black text-rose-400">Rp 0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- INPUT SECTION (Smaller) -->
        <div class="px-5 py-6">
            <div class="bg-slate-900/40 rounded-3xl p-5 border border-white/5 mb-8">
                <div class="flex justify-between mb-4">
                    <span id="form-title" class="text-[10px] font-black uppercase tracking-widest text-slate-500">Input Baru</span>
                    <button id="cancel-edit" onclick="resetForm()" class="hidden text-rose-500 text-[10px] font-bold">BATAL</button>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="date" id="t-date" class="bg-slate-950 border border-slate-800 rounded-xl p-3 text-xs font-bold outline-none focus:border-blue-500">
                    <input type="tel" id="t-amount" oninput="formatDisplayAmount(this)" placeholder="Nominal" class="bg-slate-950 border border-slate-800 rounded-xl p-3 text-xs font-bold outline-none focus:border-blue-500">
                </div>
                <input type="text" id="t-desc" placeholder="Keterangan..." class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-xs font-bold outline-none mb-4 focus:border-blue-500">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveToCloud('IN')" class="btn-action bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold text-[11px] uppercase tracking-wide">Dana Masuk</button>
                    <button onclick="saveToCloud('OUT')" class="btn-action bg-rose-600 hover:bg-rose-500 py-3 rounded-xl font-bold text-[11px] uppercase tracking-wide">Pengeluaran</button>
                </div>
            </div>

            <!-- HISTORY SECTION -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-sm uppercase tracking-widest text-slate-400">Riwayat</h3>
                <input type="month" id="filter-month" onchange="updateUI()" class="bg-transparent border-none text-blue-500 font-bold text-xs outline-none">
            </div>

            <div id="transaction-list" class="space-y-2">
                <!-- List items -->
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwiKSUdRHExo6dd_z03wf5TckjDNSUVJRevpoVBBLFdU1LFVf1X2KnPHU5zp2wUd4TW6g/exec"; 
        let currentPin = "", CORRECT_PIN = "123456", transactions = [], editId = null;

        window.onload = () => {
            const now = new Date();
            document.getElementById('t-date').valueAsDate = now;
            document.getElementById('filter-month').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        };

        function inputPin(d) { if(currentPin.length < 6) { currentPin += d; updateDots(); if(currentPin.length === 6) setTimeout(checkPin, 200); } }
        function clearPin() { currentPin = ""; updateDots(); }
        function updateDots() { for(let i=1; i<=6; i++) document.getElementById(`dot-${i}`).className = i <= currentPin.length ? "w-3 h-3 rounded-full bg-blue-500 shadow-[0_0_8px_#3b82f6]" : "w-3 h-3 rounded-full border border-slate-700"; }
        function checkPin() { if(currentPin === CORRECT_PIN) unlockApp(); else { alert("PIN SALAH"); clearPin(); } }
        
        function unlockApp() { 
            const auth = document.getElementById('auth-overlay');
            const app = document.getElementById('main-app');
            auth.style.opacity = '0'; 
            setTimeout(() => { 
                auth.style.display = 'none'; 
                app.classList.remove('hidden');
                setTimeout(() => app.style.opacity = '1', 50);
                fetchFromCloud(); 
            }, 500); 
        }

        async function fetchFromCloud() {
            toggleLoading(true);
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                transactions = data.map(item => ({...item, amount: parseInt(item.amount)}));
                updateUI();
            } catch (e) { alert("Gagal mengambil data."); }
            toggleLoading(false);
        }

        async function saveToCloud(type) {
            const amountStr = document.getElementById('t-amount').value.replace(/\D/g, '');
            const amount = parseInt(amountStr) || 0;
            const desc = document.getElementById('t-desc').value;
            const date = document.getElementById('t-date').value;
            
            if (!desc || amount <= 0 || !date) { alert("Data tidak lengkap"); return; }
            
            toggleLoading(true);
            try {
                await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        action: editId ? 'edit' : 'add', 
                        id: editId || Date.now().toString(), 
                        date, description: desc, amount, type 
                    }) 
                });
                await fetchFromCloud(); 
                resetForm();
            } catch (e) { alert("Gagal menyimpan."); }
            toggleLoading(false);
        }

        function toggleLoading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }
        function formatDisplayAmount(input) { let v = input.value.replace(/\D/g, ""); input.value = v ? new Intl.NumberFormat('id-ID').format(v) : ""; }
        function formatIDR(n) { return "Rp " + new Intl.NumberFormat('id-ID').format(n); }
        
        function resetForm() { 
            editId = null; 
            document.getElementById('t-desc').value = ""; 
            document.getElementById('t-amount').value = ""; 
            document.getElementById('form-title').innerText = "Input Baru"; 
            document.getElementById('cancel-edit').classList.add('hidden'); 
        }

        function startEdit(id) {
            const t = transactions.find(x => x.id.toString() === id.toString());
            if(!t) return;
            editId = id; 
            document.getElementById('t-date').value = t.date; 
            document.getElementById('t-desc').value = t.description;
            document.getElementById('t-amount').value = new Intl.NumberFormat('id-ID').format(t.amount);
            document.getElementById('form-title').innerText = "Edit Transaksi"; 
            document.getElementById('cancel-edit').classList.remove('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function updateUI() {
            const list = document.getElementById('transaction-list'), filterMonth = document.getElementById('filter-month').value;
            list.innerHTML = ""; let totalBal = 0, mIn = 0, mOut = 0;
            
            transactions.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
                const isIn = t.type === 'IN'; totalBal += isIn ? t.amount : -t.amount;
                if (t.date.startsWith(filterMonth)) { if (isIn) mIn += t.amount; else mOut += t.amount; }
            });

            document.getElementById('total-balance').innerText = formatIDR(totalBal);
            document.getElementById('month-in').innerText = formatIDR(mIn);
            document.getElementById('month-out').innerText = formatIDR(mOut);

            const filtered = transactions.filter(t => t.date.startsWith(filterMonth)).sort((a,b) => new Date(b.date) - new Date(a.date));
            if(filtered.length === 0) {
                list.innerHTML = `<div class="py-10 text-center text-slate-600 text-[10px] font-bold uppercase tracking-widest">Belum ada aktivitas</div>`;
                return;
            }

            filtered.forEach(t => {
                const isIn = t.type === 'IN';
                const item = document.createElement('div');
                item.className = "glass-card p-4 rounded-2xl flex items-center justify-between btn-action";
                item.onclick = () => startEdit(t.id);
                
                // Formatting date to be shorter to avoid overlap
                const shortDate = new Date(t.date).toLocaleDateString('id-ID', {day:'2-digit', month:'short'});
                
                item.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-1.5 h-6 rounded-full ${isIn ? 'bg-emerald-500' : 'bg-rose-500'}"></div>
                        <div class="overflow-hidden">
                            <p class="font-bold text-xs text-truncate">${t.description}</p>
                            <p class="text-[9px] text-slate-500 font-bold uppercase">${shortDate}</p>
                        </div>
                    </div>
                    <p class="font-black text-xs shrink-0 ${isIn ? 'text-emerald-400' : 'text-rose-400'}">${isIn ? '+' : '-'} ${new Intl.NumberFormat('id-ID').format(t.amount)}</p>
                `;
                list.appendChild(item);
            });
        }
    </script>
</body>
</html>

w
